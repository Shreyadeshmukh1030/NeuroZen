<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Round 2 Assessment | Enhanced UI - TOTAL/100 SCORING</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'brand-primary': '#3b82f6',
            'brand-secondary': '#06b6d4',
            'brand-accent': '#ec4899',
            'neutral-dark': '#0f172a',
            'neutral-light': '#f8fafc',
            'neutral-border': '#e2e8f0',
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            display: ['Plus Jakarta Sans', 'Inter', 'sans-serif'],
          },
          boxShadow: {
            'sm-light': '0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            'md-light': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
            'lg-light': '0 10px 15px -3px rgba(0, 0, 0, 0.08)',
          }
        },
      },
    }
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet" />

  <style>
    * {
      font-family: 'Inter', ui-sans-serif;
    }

    body {
      background: #ffffff;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      z-index: -1;
      pointer-events: none;
    }

    .glass {
      background: #ffffff;
      backdrop-filter: blur(10px);
      border: 1px solid #e2e8f0;
    }

    .card-shadow {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.04);
    }

    .smooth-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .slide-in-up {
      animation: slideInUp 0.6s ease-out forwards;
    }

    /* Navbar Styles */
    .navbar {
      background: #ffffff;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .nav-item {
      position: relative;
      padding: 0.6rem 1.1rem;
      border-radius: 0.65rem;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.6rem;
      font-weight: 500;
      font-size: 0.9rem;
      color: #64748b;
      cursor: pointer;
      white-space: nowrap;
    }

    .nav-item:hover {
      background-color: #f1f5f9;
      color: #3b82f6;
    }

    .nav-item.active {
      background-color: #eff6ff;
      color: #3b82f6;
      font-weight: 600;
    }

    .nav-item.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 1.1rem;
      right: 1.1rem;
      height: 2px;
      background: #3b82f6;
      border-radius: 1px;
    }

    .user-avatar {
      width: 2.2rem;
      height: 2.2rem;
      border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.25s ease;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .user-avatar:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col font-sans">
  <!-- Navigation Bar -->
  <nav class="navbar sticky top-0 z-50">
    <div class="max-w-7xl mx-auto w-full px-4 md:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
      <div class="w-9 h-9 bg-brand-primary text-white flex items-center justify-center rounded-lg font-bold">‚ô°</div>
      <span class="font-bold text-lg">MindCare</span>
    </div>

      <div class="nav-menu flex items-center gap-2 md:gap-1">
        <a href="round1.html" class="nav-item" data-page="dashboard">
          <span>üìä</span>
          <span class="hidden md:inline">Dashboard</span>
        </a>
        <a href="#chat" class="nav-item" data-page="chat">
          <span>üí¨</span>
          <span class="hidden md:inline">Chat Assistant</span>
        </a>
        <a href="#doctor" class="nav-item" data-page="doctor">
          <span>üë®‚Äç‚öïÔ∏è</span>
          <span class="hidden md:inline">Doctor Consult</span>
        </a>
        <a href="#report" class="nav-item" data-page="report">
          <span>üìã</span>
          <span class="hidden md:inline">Report</span>
        </a>
        <a href="#profile" class="nav-item" data-page="profile">
          <span>üë§</span>
          <span class="hidden md:inline">Profile</span>
        </a>
      </div>

      <div class="flex items-center gap-4">
        
        <button class="nav-item" id="logoutBtn" onclick="handleLogout()">
          <span>üö™</span>
          <span class="hidden md:inline">Logout</span>
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="flex-1 min-h-screen flex items-center justify-center p-4 md:p-8 font-sans">
  <div class="max-w-7xl w-full grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 slide-in-up">

    <!-- LEFT: ASSESSMENT -->
    <div class="lg:col-span-2 flex justify-center">
      <div class="glass rounded-xl card-shadow border p-8 md:p-10 w-full max-w-2xl">
        <!-- Header -->
        <div class="flex items-center justify-between mb-12 select-none">
          <div>
            <span id="stepText" class="text-xs font-semibold text-brand-primary uppercase tracking-wider block mb-1"></span>
            <span class="text-sm text-slate-500 font-medium">Mental Health Assessment</span>
          </div>
          <div class="w-32 h-2 bg-slate-200 rounded-full overflow-hidden">
            <div id="progressBar" class="h-2 bg-gradient-to-r from-brand-primary to-brand-secondary rounded-full transition-all duration-500 ease-out"></div>
          </div>
        </div>

        <!-- Question -->
        <h2 id="questionText" class="text-2xl md:text-3xl font-bold text-neutral-dark mb-10 leading-tight font-display"></h2>

        <!-- Form -->
        <form id="questionForm" class="space-y-6">
          <div id="optionsContainer"></div>
          <div class="mt-14 pt-8 border-t border-slate-200 flex justify-between items-center">
            <button type="button" id="backBtn" class="group text-slate-600 font-medium hover:text-brand-primary disabled:opacity-30 transition-all duration-250 px-5 py-2.5 rounded-lg select-none flex items-center gap-2 hover:bg-slate-100 disabled:cursor-not-allowed">
              <span class="text-lg leading-none transform group-hover:-translate-x-1 transition-transform duration-250">‚Üê</span> Back
            </button>
            <button type="submit" id="nextBtn" class="bg-brand-primary hover:bg-blue-600 active:bg-blue-700 text-white px-8 md:px-10 py-2.5 rounded-lg font-semibold transition-all duration-250 transform hover:shadow-md active:scale-95 select-none focus:ring-2 focus:ring-blue-500/50 disabled:opacity-50 disabled:cursor-not-allowed">
              Continue ‚Üí
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- RIGHT: TIPS & QUOTES -->
    <aside class="hidden lg:flex flex-col glass rounded-xl card-shadow border p-8 sticky top-24 max-h-[75vh] overflow-y-auto">
      <!-- Quote -->
      <div class="mb-10 flex-grow flex flex-col justify-center items-center px-4 text-center py-6">
        <div class="mb-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-brand-primary/60 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7.17 8A3.001 3.001 0 008 15h0a3 3 0 002.83-4H7.17zM4.5 12a4.5 4.5 0 014.5-4.5M19.5 12a4.5 4.5 0 00-4.5-4.5" />
          </svg>
        </div>
        <p id="healthQuote" class="text-base italic font-medium text-slate-700 leading-relaxed"></p>
      </div>

      <!-- Wellness Tips -->
      <div class="bg-blue-50 rounded-lg p-6 border border-blue-100">
        <div class="flex items-center gap-2 mb-5">
          <div class="h-1.5 w-6 bg-brand-primary rounded-full"></div>
          <h3 class="text-lg font-semibold text-slate-900">Wellness Tips</h3>
          <span class="text-xs font-semibold text-emerald-700 bg-emerald-100 px-2.5 py-0.5 rounded-full">Round 2 of 2</span>
        </div>
        <ul class="space-y-3">
          <li class="flex items-start gap-3">
            <span class="text-lg flex-shrink-0">ü´Å</span>
            <span class="text-slate-700 font-medium text-sm">Breathing reduces anxiety instantly</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-lg flex-shrink-0">üö∂</span>
            <span class="text-slate-700 font-medium text-sm">Movement improves emotional regulation</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-lg flex-shrink-0">üíß</span>
            <span class="text-slate-700 font-medium text-sm">Hydration impacts mood and focus</span>
          </li>
          <li class="flex items-start gap-3">
            <span class="text-lg flex-shrink-0">üìµ</span>
            <span class="text-slate-700 font-medium text-sm">Limit screens before sleep</span>
          </li>
        </ul>
      </div>

      <footer class="mt-auto text-center text-xs font-medium text-slate-500 mt-6 pt-5 border-t border-slate-200">
        Complete assessment for your TOTAL/100 score
      </footer>
    </aside>
  </div>

  <script>
    // AUTH CHECK - REDIRECT IF NOT LOGGED IN
    if (!localStorage.getItem('mindwellToken')) {
      alert('Please login first');
      window.location.href = 'login.html';
    }

    // CHECK IF ROUND1 COMPLETED
    const round1Data = localStorage.getItem('round1Result');
    if (!round1Data) {
      alert('Please complete Round 1 first!');
      window.location.href = 'round1.html';
    }

    const quotes = [
      "Your mental health matters just as much as your physical health.",
      "Healing is not linear ‚Äî be kind to yourself.",
      "Small steps every day lead to meaningful change.",
      "It's okay to slow down. You are not falling behind.",
      "Taking care of your mind is a form of strength."
    ];

    function setRandomQuote() {
      document.getElementById("healthQuote").innerText = `"${quotes[Math.floor(Math.random() * quotes.length)]}"`;
    }
    setRandomQuote();

    /* ---------------- QUESTIONS ---------------- */
    const questions = [
      { id: "q1", text: "Do you feel pressure to meet deadlines?", type: "select", options: ["Not at all", "Mild", "Moderate", "Severe"] },
      { id: "q2", text: "How regular are your meals?", type: "scale", labels: {1: "Very irregular", 2: "Somewhat irregular", 3: "Average", 4: "Mostly regular", 5: "Very regular"} },
      { id: "q3", text: "Do you get physical symptoms like sweating, rapid heartbeat, or trembling?", type: "select", options: ["Never", "Sometimes", "Often"] },
      { id: "q4", text: "Do you feel hopeless about the future?", type: "select", options: ["Not at all", "Sometimes", "Often"] },
      { id: "q5", text: "Do you feel socially isolated?", type: "select", options: ["Never", "Sometimes", "Often"] },
      { id: "q6", text: "Have you had thoughts of harming yourself?", type: "select", options: ["Never", "Rarely", "Sometimes", "Often"] },
      { id: "q7", text: "Do you practice mindfulness or relaxation techniques?", type: "select", options: ["Never", "Occasionally", "Regularly"] },
    ];

    /* ---------------- STATE ---------------- */
    let currentStep = 0;
    let answers = {};
    let loading = false;

    /* ---------------- DOM ---------------- */
    const questionText = document.getElementById("questionText");
    const optionsContainer = document.getElementById("optionsContainer");
    const stepText = document.getElementById("stepText");
    const progressBar = document.getElementById("progressBar");
    const backBtn = document.getElementById("backBtn");
    const form = document.getElementById("questionForm");
    const nextBtn = document.getElementById("nextBtn");

    /* ---------------- RENDER ---------------- */
    function renderQuestion() {
      const q = questions[currentStep];
      stepText.innerText = `Question ${currentStep + 1} / ${questions.length}`;
      const progress = ((currentStep + 1) / questions.length) * 100;
      progressBar.style.width = progress + "%";
      questionText.innerText = q.text;
      optionsContainer.innerHTML = "";
      backBtn.disabled = currentStep === 0;

      // SCALE
      if (q.type === "scale") {
        for (let i = 1; i <= 5; i++) {
          const selected = answers[q.id] == i;
          optionsContainer.innerHTML += `
            <label class="option-hover group block border p-4 md:p-5 rounded-lg cursor-pointer transition-all duration-250 mb-3 ${selected ? 'bg-blue-500 text-white shadow-md border-blue-600' : 'bg-slate-50 border-slate-200 hover:border-blue-300 hover:bg-blue-50 hover:shadow-sm'}">
              <div class="flex items-center gap-4">
                <input type="radio" name="${q.id}" hidden value="${i}" ${selected ? "checked" : ""} />
                <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-semibold text-sm flex-shrink-0 ${selected ? 'border-white bg-white/20' : 'border-slate-300 bg-white group-hover:border-blue-400'}">
                  ${selected ? '‚úì' : i}
                </div>
                <div class="flex-grow">
                  <span class="block font-semibold">${i}</span>
                  <span class="text-xs ${selected ? 'text-blue-100' : 'text-slate-600'}">${q.labels ? q.labels[i] : ""}</span>
                </div>
              </div>
            </label>
          `;
        }
      }

      // SELECT
      if (q.type === "select") {
        q.options.forEach((opt, idx) => {
          const selected = answers[q.id] === opt;
          optionsContainer.innerHTML += `
            <label class="option-hover group block border p-4 md:p-5 rounded-lg cursor-pointer transition-all duration-250 mb-3 ${selected ? 'bg-blue-500 text-white shadow-md border-blue-600' : 'bg-slate-50 border-slate-200 hover:border-blue-300 hover:bg-blue-50 hover:shadow-sm'}">
              <div class="flex items-center gap-4">
                <input type="radio" name="${q.id}" hidden value="${opt}" ${selected ? "checked" : ""} />
                <div class="w-10 h-10 rounded-full border-2 flex items-center justify-center font-semibold text-sm flex-shrink-0 ${selected ? 'border-white bg-white/20' : 'border-slate-300 bg-white group-hover:border-blue-400'}">
                  ${selected ? '‚úì' : (idx + 1)}
                </div>
                <span class="font-semibold">${opt}</span>
              </div>
            </label>
          `;
        });
      }

      // Button label
      nextBtn.innerText = loading ? "Calculating..." : currentStep === questions.length - 1 ? "Finish & Get Results" : "Continue";
      setRandomQuote();
    }

    /* ---------------- EVENTS ---------------- */
    optionsContainer.addEventListener("click", (e) => {
      const label = e.target.closest("label");
      if (!label) return;
      const input = label.querySelector("input");
      if (!input) return;
      answers[questions[currentStep].id] = input.value;
      renderQuestion();
    });

    backBtn.addEventListener("click", () => {
      if (currentStep > 0) {
        currentStep--;
        renderQuestion();
      }
    });

    // üî• NEW SUBMIT - SENDS ROUND1 + ROUND2 TO GET TOTAL/100
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      console.log('üîç ROUND2 ANSWERS:', answers);

      if (currentStep < questions.length - 1) {
        currentStep++;
        renderQuestion();
        return;
      }

      const token = localStorage.getItem('mindwellToken');
      console.log('üîë TOKEN:', token ? 'OK' : 'MISSING');

      if (!token) {
        alert('Please login first!');
        window.location.href = 'login.html';
        return;
      }

      // ‚úÖ GET ROUND1 FROM LOCALSTORAGE
      const round1Result = JSON.parse(localStorage.getItem('round1Result') || '{}');
      const round1_answers = round1Result.answers || {};
      
      console.log('üìä ROUND1 DATA:', round1_answers);
      console.log('üìä ROUND2 DATA:', answers);

      loading = true;
      nextBtn.disabled = true;
      nextBtn.innerText = "Calculating Total Score...";
      renderQuestion();

      try {
        console.log('üì§ SENDING COMPLETE ASSESSMENT (Round1+Round2)...');
        const response = await fetch('http://localhost:5000/api/assessments/complete', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ 
            round1_answers,  // 10 questions from Round1
            round2_answers: answers  // 7 questions from Round2
          })
        });

        const result = await response.json();
        console.log('‚úÖ TOTAL/100 RESULT:', result);

        if (response.ok && result.success) {
          // ‚úÖ SAVE FINAL RESULT & REDIRECT
          localStorage.setItem("finalResult", JSON.stringify(result));
          localStorage.setItem("latestAssessment", JSON.stringify({ round: 3, ...result }));
          window.location.href = "results.html";
        } else {
          alert('‚ùå Save failed: ' + (result.error || result.message || 'Unknown error'));
        }
      } catch (error) {
        console.error('üí• NETWORK ERROR:', error);
        alert('Backend error!\n1. Check backend is running\n2. cd backend && node server.js');
      } finally {
        loading = false;
        nextBtn.disabled = false;
        renderQuestion();
      }
    });

    /* ---------------- INIT ---------------- */
    renderQuestion();

    // ==================== NAVIGATION FUNCTIONS ====================
    
    function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('mindwellToken');
        localStorage.removeItem('round1Result');
        localStorage.removeItem('round2Result');
        localStorage.removeItem('currentPage');
        console.log('Logged out successfully');
        window.location.href = 'login.html';
      }
    }

    // Handle navigation item clicks
    document.querySelectorAll('.nav-item[data-page]').forEach(item => {
      item.addEventListener('click', function(e) {
        const page = this.getAttribute('data-page');
        if (page) {
          e.preventDefault();
          handleNavigation(page);
        }
      });
    });

    function handleNavigation(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      const navItem = document.querySelector(`[data-page="${page}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }

      localStorage.setItem('currentPage', page);
      
      const pages = {
        'dashboard': 'round1.html',
        'chat': 'chat-assistant.html',
        'doctor': 'doctor-consult.html',
        'report': 'report.html',
        'profile': 'profile.html'
      };

      if (pages[page]) {
        window.location.href = pages[page];
      }
    }

    function restoreNavState() {
      const currentPage = localStorage.getItem('currentPage') || 'dashboard';
      const navItem = document.querySelector(`[data-page="${currentPage}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }
    }

    restoreNavState();
  </script>
</body>
</html>
